<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Prompt Studio - OpenAI/Gemini (Web)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- MathJax CDN for LaTeX rendering -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            transition: background-color 0.3s ease;
        }
        /* Custom scrollbar for better aesthetics */
        textarea::-webkit-scrollbar, .overflow-y-auto::-webkit-scrollbar,
        .markdown-output::-webkit-scrollbar, #customVarsList::-webkit-scrollbar {
            width: 6px; /* Reduced scrollbar width */
            height: 6px; /* Reduced scrollbar height */
        }
        textarea::-webkit-scrollbar-track, .overflow-y-auto::-webkit-scrollbar-track,
        .markdown-output::-webkit-scrollbar-track, #customVarsList::-webkit-scrollbar-track {
            background: #e0e0e0;
            border-radius: 10px;
        }
        textarea::-webkit-scrollbar-thumb, .overflow-y-auto::-webkit-scrollbar-thumb,
        .markdown-output::-webkit-scrollbar-thumb, #customVarsList::-webkit-scrollbar-thumb {
            background: #bdbdbd;
            border-radius: 10px;
        }
        textarea::-webkit-scrollbar-thumb:hover, .overflow-y-auto::-webkit-scrollbar-thumb:hover,
        .markdown-output::-webkit-scrollbar-thumb:hover, #customVarsList::-webkit-scrollbar-thumb:hover {
            background: #888;
        }
        /* Styling for markdown output - proportionally reduced */
        .markdown-output h1 {
            font-size: 1.5rem; /* text-2xl reduced from 3xl */
            font-weight: 700;    /* font-bold */
            margin-top: 0.75rem; /* mt-3 reduced from mt-6 */
            margin-bottom: 0.375rem; /* mb-1.5 reduced from mb-3 */
        }
        .markdown-output h2 {
            font-size: 1.25rem;   /* text-xl reduced from 2xl */
            font-weight: 600;    /* font-semibold */
            margin-top: 0.625rem; /* mt-2.5 reduced from mt-5 */
            margin-bottom: 0.3rem; /* mb-1 reduced from mb-2.5 */
        }
        .markdown-output strong, .markdown-output b {
            font-weight: 700; /* font-bold */
        }
        .markdown-output em, .markdown-output i {
            font-style: italic;
        }
        .markdown-output ul {
            list-style-type: disc;
            margin-left: 1rem; /* ml-4 reduced from ml-5 */
            margin-bottom: 0.25rem; /* mb-1 reduced from mb-2 */
        }
        .markdown-output ol {
            list-style-type: decimal;
            margin-left: 1rem; /* ml-4 reduced from ml-5 */
            margin-bottom: 0.25rem; /* mb-1 reduced from mb-2 */
        }
        .markdown-output li {
            margin-bottom: 0.125rem; /* mb-0.5 reduced from mb-1 */
        }
        .markdown-output pre {
            background-color: #e5e7eb; /* gray-200 */
            padding: 0.5rem; /* p-2 reduced from p-3 */
            border-radius: 0.375rem; /* rounded-md reduced from rounded-lg */
            overflow-x: auto;
            margin-top: 0.375rem; /* mt-1.5 reduced from mt-3 */
            margin-bottom: 0.375rem; /* mb-1.5 reduced from mt-3 */
            font-family: 'Courier New', monospace;
            font-size: 0.75rem; /* text-xs reduced from text-sm */
        }
        .markdown-output code {
            background-color: #d1d5db; /* gray-300 */
            padding: 0.125rem 0.25rem; /* px-1 py-0.5 reduced from px-2 py-1 */
            border-radius: 0.125rem; /* rounded-xs reduced from rounded */
            font-family: 'Courier New', monospace;
            font-size: 0.75rem; /* text-xs reduced from text-sm */
        }
        .markdown-output table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem; /* reduced from 1rem */
            margin-bottom: 0.5rem; /* reduced from 1rem */
            font-family: 'Courier New', monospace;
        }
        .markdown-output th, .markdown-output td {
            border: 1px solid #d1d5db; /* gray-300 */
            padding: 0.375rem; /* reduced from 0.75rem */
            text-align: left;
        }
        .markdown-output th {
            background-color: #e5e7eb; /* gray-200 */
            font-weight: 600;
        }
        .markdown-output img { /* Styles for images in output */
            max-width: 100%;
            height: auto;
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-top: 0.75rem;
            margin-bottom: 0.75rem;
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        /* Default modal content for smaller modals (Manage Variables, Quick Guide, Examples) */
        .modal-content {
            background-color: white;
            padding: 1rem; /* Reduced from 1.5rem */
            border-radius: 0.5rem; /* Reduced from 0.75rem */
            box-shadow: 0 5px 10px -2px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.05); /* Reduced shadow */
            width: 90%; /* Maintained width responsiveness */
            max-width: 500px; /* Reduced for smaller modals */
            max-height: 85vh; /* Reduced from 95vh */
            overflow-y: auto;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Specific style for Full View Output modal content to be larger */
        #fullViewModal .modal-content {
            max-width: 1200px; /* Reverted to larger width for full view */
        }

        /* Loading indicator for button */
        .btn-loading {
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Toast notification */
        .toast-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .toast-notification.show {
            opacity: 1;
        }

        /* Dark Mode Styles */
        body.dark {
            background-color: #1a202c; /* dark gray */
            color: #e2e8f0; /* light gray text */
        }

        body.dark .bg-white {
            background-color: #2d3748; /* darker shade for cards */
            color: #e2e8f0;
        }

        body.dark .text-gray-800 {
            color: #e2e8f0;
        }

        body.dark .text-gray-700 {
            color: #cbd5e0;
        }

        body.dark .border-gray-300 {
            border-color: #4a5568;
        }

        body.dark select,
        body.dark input[type="text"],
        body.dark textarea {
            background-color: #4a5568;
            border-color: #6a7386;
            color: #e2e8f0;
        }

        body.dark select option {
            background-color: #4a5568;
            color: #e2e8f0;
        }

        body.dark .bg-gray-50 {
            background-color: #2d3748;
        }

        body.dark .markdown-output pre {
            background-color: #4a5568;
        }

        body.dark .markdown-output code {
            background-color: #6a7386;
        }

        body.dark .markdown-output th,
        body.dark .markdown-output td {
            border-color: #4a5568;
        }

        body.dark .markdown-output th {
            background-color: #4a5568;
        }

        body.dark .modal-content {
            background-color: #2d3748;
            color: #e2e8f0;
        }

        /* Update for the new attach image button color in dark mode */
        body.dark #attachImageBtn {
            background-color: #3182ce; /* a slightly darker blue for dark mode */
            color: #e2e8f0;
        }
        body.dark #attachImageBtn:hover {
            background-color: #2b6cb0; /* even darker blue on hover */
        }

        body.dark .bg-gray-300 {
            background-color: #4a5568;
            color: #e2e8f0;
        }

        body.dark .hover\:bg-gray-400:hover {
            background-color: #6a7386;
        }

        body.dark .text-gray-500 {
            color: #a0aec0;
        }

        body.dark .text-red-500 {
            color: #fc8181;
        }

        body.dark .bg-yellow-500 {
            background-color: #ecc94b;
        }

        body.dark .hover\:bg-yellow-600:hover {
            background-color: #d69e2e;
        }

        body.dark .bg-purple-600 {
            background-color: #805ad5;
        }

        body.dark .hover\:bg-purple-700:hover {
            background-color: #6b46c1;
        }

        body.dark .bg-blue-200 {
            background-color: #63b3ed;
        }

        body.dark .hover\:bg-gray-100:hover {
            background-color: #4a5568;
        }

        /* New dark mode styles for the export button */
        body.dark .bg-orange-500 {
            background-color: #ed8936;
        }
        body.dark .hover\:bg-orange-600:hover {
            background-color: #dd6b20;
        }

    </style>
</head>
<body class="p-2 md:p-3 lg:p-4 min-h-screen flex flex-col">

    <div class="flex-grow grid grid-cols-1 lg:grid-cols-3 gap-3 min-h-0">
        <div class="bg-white p-3 rounded-lg shadow-md flex flex-col">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-lg font-bold text-gray-800">Options & Context</h2>
                <button class="text-gray-500 hover:text-gray-700 transition-colors duration-200"
                        data-collapse-target="optionsPanelContent" data-panel-id="optionsPanel" title="Toggle visibility">
                    <i class="fas fa-chevron-up" id="optionsPanelIcon"></i>
                </button>
            </div>
            <div id="optionsPanelContent" class="space-y-2 flex-grow overflow-y-auto pr-1">
                <div>
                    <label for="modelSelect" class="block text-xs font-medium text-gray-700">Select AI Model:</label>
                    <select id="modelSelect" class="mt-0.5 block w-full pl-2 pr-5 py-1 text-sm border-gray-300 focus:outline-none focus:ring-green-500 focus:border-green-500 rounded-md shadow-sm">
                        <option value="openai">OpenAI (GPT-4o)</option>
                        <option value="gemini">Google (Gemini 1.5 Flash)</option>
                    </select>
                </div>
                <div>
                    <label for="tone" class="block text-xs font-medium text-gray-700">General Style/Tone:</label>
                    <select id="tone" class="mt-0.5 block w-full pl-2 pr-5 py-1 text-sm border-gray-300 focus:outline-none focus:ring-green-500 focus:border-green-500 rounded-md shadow-sm">
                        <option>Default/Neutral</option>
                        <option>Polite</option>
                        <option>Casual</option>
                        <option>Assertive</option>
                        <option>Friendly</option>
                        <option>Professional</option>
                        <option>Enthusiastic</option>
                    </select>
                </div>
                <div>
                    <label for="language" class="block text-xs font-medium text-gray-700">Output Language:</label>
                    <select id="language" class="mt-0.5 block w-full pl-2 pr-5 py-1 text-sm border-gray-300 focus:outline-none focus:ring-green-500 focus:border-green-500 rounded-md shadow-sm">
                        <option>English</option>
                        <option>Vietnamese</option>
                        <option>Spanish</option>
                        <option>French</option>
                        <option>Germany</option>
                        <option>Japanese</option>
                        <option>Korean</option>
                        <option>Chinese (Simplified)</option>
                        <option>Chinese (Traditional)</option>
                    </select>
                </div>
                <div>
                    <label for="length" class="block text-xs font-medium text-gray-700">Desired Output Length:</label>
                    <select id="length" class="mt-0.5 block w-full pl-2 pr-5 py-1 text-sm border-gray-300 focus:outline-none focus:ring-green-500 focus:border-green-500 rounded-md shadow-sm">
                        <option>Flexible (let AI decide best length)</option>
                        <option>Short & Concise</option>
                        <option>Medium (2-3 lines)</option>
                        <option>Longer Explanation</option>
                        <option>Similar to the original text (+/-10%)</option>
                    </select>
                </div>
                <div>
                    <label for="channel" class="block text-xs font-medium text-gray-700">Communication Channel:</label>
                    <select id="channel" class="mt-0.5 block w-full pl-2 pr-5 py-1 text-sm border-gray-300 focus:outline-none focus:ring-green-500 focus:border-green-500 rounded-md shadow-sm">
                        <option>Email (more formal structure)</option>
                        <option>Chat Message (more concise)</option>
                        <option>Report/Note</option>
                        <option>Presentation</option>
                        <option>Meeting Minutes</option>
                    </select>
                </div>
                <div>
                    <label for="recipient" class="block text-xs font-medium text-gray-700">Recipient:</label>
                    <select id="recipient" class="mt-0.5 block w-full pl-2 pr-5 py-1 text-sm border-gray-300 focus:outline-none focus:ring-green-500 focus:border-green-500 rounded-md shadow-sm">
                        <option>Superior / Manager</option>
                        <option>Client</option>
                        <option>Peer</option>
                        <option>Team</option>
                        <option>General Audience</option>
                        <option>Subordinate</option>
                    </select>
                </div>
                <div>
                    <label for="relationship" class="block text-xs font-medium text-gray-700">Relationship with Recipient:</label>
                    <select id="relationship" class="mt-0.5 block w-full pl-2 pr-5 py-1 text-sm border-gray-300 focus:outline-none focus:ring-green-500 focus:border-green-500 rounded-md shadow-sm">
                        <option>Somewhat Familiar / Acquaintance</option>
                        <option>Close Colleague</option>
                        <option>Stranger</option>
                        <option>Internal Only</option>
                        <option>External Partner</option>
                    </select>
                </div>
                <div>
                    <label for="vocab_style" class="block text-xs font-medium text-gray-700">Vocabulary Style:</label>
                    <select id="vocab_style" class="mt-0.5 block w-full pl-2 pr-5 py-1 text-sm border-gray-300 focus:outline-none focus:ring-green-500 focus:border-green-500 rounded-md shadow-sm">
                        <option>Natural / Conversational</option>
                        <option>Formal</option>
                        <option>Simple Words</option>
                        <option>Professional Jargon</option>
                        <option>Academic</option>
                    </select>
                </div>
                <div>
                    <label for="role" class="block text-xs font-medium text-gray-700">Your Role:</label>
                    <select id="role" class="mt-0.5 block w-full pl-2 pr-5 py-1 text-sm border-gray-300 focus:outline-none focus:ring-green-500 focus:border-green-500 rounded-md shadow-sm">
                        <option>General</option>
                        <option>Finance / Accounting</option>
                        <option>HR</option>
                        <option>Engineering</option>
                    </select>
                </div>
                <div>
                    <label for="industry" class="block text-xs font-medium text-gray-700">Your Industry:</label>
                    <select id="industry" class="mt-0.5 block w-full pl-2 pr-5 py-1 text-sm border-gray-300 focus:outline-none focus:ring-green-500 focus:border-green-500 rounded-md shadow-sm">
                        <option>General</option>
                        <option>Technology (Software Development)</option>
                        <option>Technology (General)</option>
                        <option>Manufacturing (General)</option>
                        <option>Manufacturing (Garments/Textile)</option>
                        <option>Manufacturing (Plastic Manufacturing)</option>
                        <option>Others</option>
                    </select>
                </div>
            </div>

            <button id="manageVarsBtn" class="mt-2 w-full bg-yellow-500 text-gray-800 font-bold py-1 px-2 rounded-lg hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-opacity-50 transition-colors duration-200 shadow-md text-sm">
                <i class="fas fa-cog mr-1"></i>Manage Custom Variables
            </button>

            <label class="inline-flex items-center mt-1.5 cursor-pointer">
                <input type="checkbox" id="includeCustomVars" class="form-checkbox h-4 w-4 text-green-600 rounded">
                <span class="ml-1.5 text-xs text-gray-700">Include Custom Variables in Prompt</span>
            </label>

            <button id="saveDefaultBtn" class="mt-2 w-full bg-purple-600 text-white font-bold py-1 px-2 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-600 focus:ring-opacity-50 transition-colors duration-200 shadow-md text-sm">
                <i class="fas fa-save mr-1"></i>Save Default Settings
            </button>
        </div>

        <div class="bg-white p-3 rounded-lg shadow-md flex flex-col">
            <h2 class="text-lg font-bold text-gray-800">Your Input & Task</h2>
            <div>
                <label for="task" class="block text-xs font-medium text-gray-700">What would you like to do?</label>
                <select id="task" class="mt-0.5 block w-full pl-2 pr-5 py-1 text-sm border-gray-300 focus:outline-none focus:ring-green-500 focus:border-green-500 rounded-md shadow-sm">
                    <option>Improve Text</option>
                    <option>Rewrite Text</option>
                    <option>Change Tone of Text</option>
                    <option>Correct Vocabulary & Grammar (Minimal Changes)</option>
                    <option>Summarize Text</option>
                    <option>Expand on Text/Idea</option>
                    <option>Translate Text</option>
                    <option>English Learning</option>
                    <option>Dictionary</option>
                    <option>Free Prompt</option>
                </select>
            </div>
            <div class="mt-2 flex-grow flex flex-col">
                <label for="inputText" class="block text-xs font-medium text-gray-700 mb-1">Your Input Text:</label>
                <textarea id="inputText" class="flex-grow border border-gray-300 rounded-lg p-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none text-sm shadow-sm" placeholder="Enter your text here..."></textarea>
                <!-- New elements for image attachment -->
                <div class="mt-2">
                    <input type="file" id="imageAttachmentInput" accept="image/*" class="hidden">
                    <button id="attachImageBtn" class="bg-blue-500 text-white font-bold py-1 px-2 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-colors duration-200 shadow-md text-sm w-full">
                        <i class="fas fa-image mr-1"></i>Attach Image
                    </button>
                    <span id="attachedFileName" class="text-xs text-gray-600 mt-1 block"></span>
                </div>
            </div>

            <div class="mt-3 flex flex-wrap justify-center gap-2">
                <button id="generateBtn" class="bg-green-600 text-white font-bold py-1.5 px-3 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-600 focus:ring-opacity-50 transition-colors duration-200 shadow-lg text-sm">
                    <i class="fas fa-paper-plane mr-1"></i>Generate Output
                </button>
                <button id="copyBtn" class="bg-blue-600 text-white font-bold py-1.5 px-3 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-opacity-50 transition-colors duration-200 shadow-lg text-sm">
                    <i class="fas fa-clipboard mr-1"></i>Copy Output
                </button>
                <button id="clearBtn" class="bg-red-500 text-white font-bold py-1.5 px-3 rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition-colors duration-200 shadow-lg text-sm">
                    <i class="fas fa-eraser mr-1"></i>Clear All
                </button>
                <button id="quickGuideBtn" class="bg-indigo-500 text-white font-bold py-1.5 px-3 rounded-lg hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 transition-colors duration-200 shadow-lg text-sm">
                    <i class="fas fa-question-circle mr-1"></i>Quick Guide
                </button>
                <button id="promptExamplesBtn" class="bg-teal-500 text-white font-bold py-1.5 px-3 rounded-lg hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-50 transition-colors duration-200 shadow-lg text-sm">
                    <i class="fas fa-lightbulb mr-1"></i>Prompt Examples
                </button>
            </div>
        </div>

        <div class="bg-white p-3 rounded-lg shadow-md flex flex-col">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-lg font-bold text-gray-800">Generated Output</h2>
                <div class="flex items-center space-x-2">
                    <button id="darkModeToggle" class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 p-2 rounded-full shadow-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-200" title="Toggle Dark Mode">
                        <i class="fas fa-moon" id="darkModeIcon"></i>
                    </button>
                    <button class="text-gray-500 hover:text-gray-700 transition-colors duration-200"
                            data-collapse-target="outputPanelContent" data-panel-id="outputPanel" title="Toggle visibility">
                        <i class="fas fa-chevron-up" id="outputPanelIcon"></i>
                    </button>
                </div>
            </div>
            <div id="outputPanelContent" class="flex-grow flex flex-col">
                <div class="mb-2 flex-shrink-0"> <!-- Added flex-shrink-0 -->
                    <label class="block text-xs font-medium text-gray-700 opacity-0 select-none">What would you like to do?</label>
                    <select class="mt-0.5 block w-full pl-2 pr-5 py-1 text-sm border-gray-300 rounded-md opacity-0 pointer-events-none">
                        <option>Placeholder</option>
                    </select>
                </div>
                <div id="outputDisplay" class="h-0 flex-grow border border-gray-300 rounded-lg p-1.5 bg-gray-50 overflow-y-auto markdown-output resize-none text-sm shadow-inner mt-2">
                </div>
                <button id="fullViewBtn" class="mt-2 w-full bg-indigo-600 text-white font-bold py-1 px-2 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-opacity-50 transition-colors duration-200 shadow-md text-sm flex-shrink-0"> <!-- Added flex-shrink-0 -->
                    <i class="fas fa-expand mr-1"></i>Full View Output
                </button>
                <button id="readAloudBtn" class="mt-2 w-full bg-blue-500 text-white font-bold py-1 px-2 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-colors duration-200 shadow-md text-sm flex-shrink-0"> <!-- Added flex-shrink-0 -->
                    <i class="fas fa-volume-up mr-1"></i>Read Out Loud
                </button>
            </div>
        </div>
    </div>

    <div id="fullViewModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-bold">Full View Output</h3>
                <button id="closeFullViewBtn" class="bg-gray-300 text-gray-800 font-bold py-1 px-2 rounded-lg hover:bg-gray-400 transition-colors duration-200 text-sm">Close</button>
            </div>
            <div id="fullViewOutputDisplay" class="border border-gray-300 rounded-lg p-1.5 bg-gray-50 overflow-y-auto markdown-output h-[calc(85vh-80px)] text-sm shadow-inner"></div>
        </div>
    </div>

    <div id="manageVarsModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-2">Manage Custom Variables</h3>
            <div class="mb-2">
                <label for="varNameInput" class="block text-xs font-medium text-gray-700">Variable Name (e.g., Mr. A):</label>
                <input type="text" id="varNameInput" class="mt-0.5 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-1.5 text-sm">
            </div>
            <div class="mb-2">
                <label for="varDescInput" class="block text-xs font-medium text-gray-700">Description/Context:</label>
                <textarea id="varDescInput" class="mt-0.5 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-1.5 text-sm h-20 resize-y"></textarea>
            </div>
            <div class="flex gap-2 mb-2">
                <button id="addUpdateVarBtn" class="flex-1 bg-green-500 text-white font-bold py-1 px-2 rounded-lg hover:bg-green-600 transition-colors duration-200 text-sm">
                    <i class="fas fa-plus mr-1"></i>Add/Update Variable
                </button>
                <button id="clearVarFieldsBtn" class="flex-1 bg-gray-300 text-gray-800 font-bold py-1 px-2 rounded-lg hover:bg-gray-400 transition-colors duration-200 text-sm">
                    Clear Fields
                </button>
            </div>
            <div class="mb-2">
                <h4 class="text-base font-semibold text-gray-800 mb-1">Current Variables:</h4>
                <ul id="customVarsList" class="border border-gray-300 rounded-lg bg-gray-50 p-1.5 overflow-y-auto h-36 text-sm">
                    </ul>
                <button id="removeVarBtn" class="mt-1.5 w-full bg-red-500 text-white font-bold py-1 px-2 rounded-lg hover:bg-red-600 transition-colors duration-200 text-sm">
                    <i class="fas fa-times mr-1"></i>Remove Selected
                </button>
            </div>
            <div class="mt-2">
                <input type="file" id="jsonFileInput" accept=".json" class="hidden">
                <button id="importJsonBtn" class="w-full bg-blue-500 text-white font-bold py-1 px-2 rounded-lg hover:bg-blue-600 transition-colors duration-200 text-sm">
                    <i class="fas fa-file-import mr-1"></i>Import from JSON
                </button>
            </div>
            <div class="mt-2">
                <button id="exportJsonBtn" class="w-full bg-orange-500 text-white font-bold py-1 px-2 rounded-lg hover:bg-orange-600 transition-colors duration-200 text-sm">
                    <i class="fas fa-file-export mr-1"></i>Export to JSON
                </button>
            </div>
            <button id="closeManageVarsBtn" class="mt-2 w-full bg-gray-300 text-gray-800 font-bold py-1 px-2 rounded-lg hover:bg-gray-400 transition-colors duration-200 text-sm">Close</button>
        </div>
    </div>

    <div id="quickGuideModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-2">Quick Guide</h3>
            <div class="markdown-output text-sm">
                <p>Welcome to the AI Prompt Studio! Here's how to get started:</p>
                <ol>
                    <li><strong>Options & Context:</strong> On the left, select the desired AI Model, style, tone, language, and other contextual information for your output. These help the AI understand your needs better.</li>
                    <li><strong>Your Input & Task:</strong> In the middle, choose what you want to do with your text (e.g., "Improve Text", "Translate Text"). Then, enter the text you want the AI to process in the "Your Input Text" box.</li>
                    <li><strong>Custom Variables:</strong> Use "Manage Custom Variables" to add specific names, terms, or facts the AI should be aware of. Remember to check "Include Custom Variables in Prompt" to use them.</li>
                    <li><strong>Attach Image:</strong> Click "Attach Image" to include an image with your prompt. This is useful for tasks involving image analysis.</li>
                    <li><strong>Generate Output:</strong> Click "Generate Output" to get the AI's response.</li>
                    <li><strong>Review & Copy:</strong> The "Generated Output" panel on the right will display the AI's response, which can include both text and images. You can copy the text or view the output in full screen.</li>
                    <li><strong>Save Defaults:</strong> Click "Save Default Settings" to store your preferred options for future use.</li>
                </ol>
                <p><strong>Tips for Better Results:</strong></p>
                <ul>
                    <li>Be specific with your input and selected options.</li>
                    <li>For "Free Prompt," be as detailed as possible in your input text about what you want.</li>
                    <li>You can also use LaTeX for mathematical expressions (e.g., inline: <code>$E=mc^2$</code>, display: <code>$$x = \frac{-b \pm \sqrt{b^2-4ac}}{2a}$$</code>).</li>
                </ul>
            </div>
            <button id="closeQuickGuideBtn" class="mt-4 w-full bg-gray-300 text-gray-800 font-bold py-1 px-2 rounded-lg hover:bg-gray-400 transition-colors duration-200 text-sm">Close</button>
        </div>
    </div>

    <div id="promptExamplesModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-2">Prompt Examples</h3>
            <div class="markdown-output text-sm">
                <h4>Improve Text:</h4>
                <ul>
                    <li><strong>Input:</strong> "The project is good. I need more time."</li>
                    <li><strong>Task:</strong> Improve Text</li>
                    <li><strong>Options:</strong> Tone: Professional, Recipient: Superior / Manager, Length: Longer Explanation</li>
                    <li><strong>Expected Output:</strong> A more formally phrased request for an extension, perhaps detailing the reasons.</li>
                </ul>
                <h4>Translate Text:</h4>
                <ul>
                    <li><strong>Input: "Hôm nay trời đẹp quá!"</strong></li>
                    <li><strong>Task:</strong> Translate Text</li>
                    <li><strong>Options:</strong> Language: English</li>
                    <li><strong>Expected Output:</strong> "The weather is so beautiful today!"</li>
                </ul>
                <h4>Summarize Text:</h4>
                <ul>
                    <li><strong>Input:</strong> A long paragraph about climate change.</li>
                    <li><strong>Task:</strong> Summarize Text</li>
                    <li><strong>Expected Output:</strong> A concise summary of the paragraph's main points.</li>
                </ul>
                <h4>Dictionary:</h4>
                <ul>
                    <li><strong>Input:</strong> "serendipity"</li>
                    <li><strong>Task:</strong> Dictionary</li>
                    <li><strong>Options:</strong> Language: English</li>
                    <li><strong>Expected Output:</strong> Definition, pronunciation, examples, and synonyms for "serendipity".</li>
                </ul>
                <h4>Mathematical Expression Example:</h4>
                <ul>
                    <li><strong>Input:</strong> "Please write down the quadratic formula."</li>
                    <li><strong>Task:</strong> Free Prompt</li>
                    <li><strong>Expected Output:</strong> Will include: <code>$$x = \frac{-b \pm \sqrt{b^2-4ac}}{2a}$$</code> rendered as a mathematical equation.</li>
                </ul>
            </div>
            <button id="closePromptExamplesBtn" class="mt-4 w-full bg-gray-300 text-gray-800 font-bold py-1 px-2 rounded-lg hover:bg-gray-400 transition-colors duration-200 text-sm">Close</button>
        </div>
    </div>

    <div id="toastNotification" class="toast-notification"></div>

    <p class="text-xs text-gray-500 text-right mt-4 mr-4">Developed by Minh Do - 2025</p>

   <script>
        // Configure MathJax to process LaTeX enclosed in $ for inline math and $$ for display math.
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: {
                fontCache: 'global'
            }
        };

        // Store references to HTML elements
        const elements = {
            task: document.getElementById('task'),
            inputText: document.getElementById('inputText'),
            outputDisplay: document.getElementById('outputDisplay'),
            generateBtn: document.getElementById('generateBtn'),
            copyBtn: document.getElementById('copyBtn'),
            clearBtn: document.getElementById('clearBtn'),
            fullViewBtn: document.getElementById('fullViewBtn'),
            fullViewModal: document.getElementById('fullViewModal'),
            fullViewOutputDisplay: document.getElementById('fullViewOutputDisplay'),
            closeFullViewBtn: document.getElementById('closeFullViewBtn'),

            // Options dropdowns
            modelSelect: document.getElementById('modelSelect'), // New: Model selection dropdown
            tone: document.getElementById('tone'),
            language: document.getElementById('language'),
            length: document.getElementById('length'),
            channel: document.getElementById('channel'),
            recipient: document.getElementById('recipient'),
            relationship: document.getElementById('relationship'),
            vocab_style: document.getElementById('vocab_style'),
            role: document.getElementById('role'),
            industry: document.getElementById('industry'),

            // Manage Custom Variables
            manageVarsBtn: document.getElementById('manageVarsBtn'),
            manageVarsModal: document.getElementById('manageVarsModal'),
            varNameInput: document.getElementById('varNameInput'),
            varDescInput: document.getElementById('varDescInput'),
            addUpdateVarBtn: document.getElementById('addUpdateVarBtn'),
            customVarsList: document.getElementById('customVarsList'),
            removeVarBtn: document.getElementById('removeVarBtn'),
            closeManageVarsBtn: document.getElementById('closeManageVarsBtn'),
            clearVarFieldsBtn: document.getElementById('clearVarFieldsBtn'),
            includeCustomVars: document.getElementById('includeCustomVars'), // New checkbox
            saveDefaultBtn: document.getElementById('saveDefaultBtn'),
            jsonFileInput: document.getElementById('jsonFileInput'), // New file input
            importJsonBtn: document.getElementById('importJsonBtn'),   // New import button
            exportJsonBtn: document.getElementById('exportJsonBtn'),   // NEW: Export button

            // Dark Mode
            darkModeToggle: document.getElementById('darkModeToggle'),
            darkModeIcon: document.getElementById('darkModeIcon'),

            // New: Collapsible Panel elements
            optionsPanelContent: document.getElementById('optionsPanelContent'),
            optionsPanelIcon: document.getElementById('optionsPanelIcon'),
            outputPanelContent: document.getElementById('outputPanelContent'),
            outputPanelIcon: document.getElementById('outputPanelIcon'),

            // New: Quick Guide and Prompt Examples
            quickGuideBtn: document.getElementById('quickGuideBtn'),
            quickGuideModal: document.getElementById('quickGuideModal'),
            closeQuickGuideBtn: document.getElementById('closeQuickGuideBtn'),
            promptExamplesBtn: document.getElementById('promptExamplesBtn'),
            promptExamplesModal: document.getElementById('promptExamplesModal'),
            closePromptExamplesBtn: document.getElementById('closePromptExamplesBtn'),

            // Toast Notification
            toastNotification: document.getElementById('toastNotification'),

            // Read aloud button
            readAloudBtn: document.getElementById('readAloudBtn'),

            // New: Image attachment elements
            imageAttachmentInput: document.getElementById('imageAttachmentInput'),
            attachImageBtn: document.getElementById('attachImageBtn'),
            attachedFileName: document.getElementById('attachedFileName'),
        };

        // Global state variables for configuration and custom variables
        let customContextVariables = {};
        const CONFIG_KEY = 'geminiPsConfig'; // Key for localStorage
        const DARK_MODE_KEY = 'geminiPsDarkMode'; // Key for dark mode preference in localStorage
        const PANEL_COLLAPSE_STATE_KEY_PREFIX = 'geminiPsPanelCollapsed_'; // Prefix for panel collapse state

        // Helper map to store references to option dropdowns for easy access by their ID
        const optionDropdowns = {
            modelSelect: elements.modelSelect, // Add modelSelect to this map
            tone: elements.tone,
            language: elements.language,
            length: elements.length,
            channel: elements.channel,
            recipient: elements.recipient,
            relationship: elements.relationship,
            vocab_style: elements.vocab_style,
            role: elements.role,
            industry: elements.industry,
        };

        // Map to temporarily store values of disabled dropdowns
        const disabledDropdownValues = new Map();

        // Variable to store the attached image file
        let attachedFile = null;

        /**
         * Converts Markdown text to HTML using the marked.js library.
         * This is much more robust than the previous custom implementation.
         * @param {string} markdownText - The Markdown string to convert.
         * @returns {string} The HTML string.
         */
        function renderMarkdown(markdownText) {
            // Just call marked.parse() and the library will handle everything
            return marked.parse(markdownText);
        }

        /**
         * Shows a temporary toast notification.
         * @param {string} message - The message to display.
         * @param {number} duration - How long to display the toast in milliseconds.
         */
        function showToast(message, duration = 3000) {
            elements.toastNotification.textContent = message;
            elements.toastNotification.classList.add('show');
            setTimeout(() => {
                elements.toastNotification.classList.remove('show');
            }, duration);
        }

        /**
         * Updates the state (enabled/disabled and visible/hidden) of option dropdowns based on the selected task.
         * When disabled, it clears the content visually but retains the underlying value.
         * This function should be called after `loadConfig()` and when the task dropdown changes.
         */
        function updateOptionsState(showToastMessage = false) {
            const selectedTask = elements.task.value;

            // First, re-enable all dropdowns and make their parent divs visible
            for (const key in optionDropdowns) {
                const dropdown = optionDropdowns[key];
                const parentDiv = dropdown.closest('div'); // Get the parent div of the dropdown

                if (disabledDropdownValues.has(key)) {
                    dropdown.value = disabledDropdownValues.get(key); // Restore value
                    disabledDropdownValues.delete(key); // Remove from temp storage
                }
                dropdown.disabled = false; // Re-enable dropdown
                dropdown.classList.remove('opacity-50', 'pointer-events-none'); // Remove visual disabled state
                dropdown.removeAttribute('title'); // Remove tooltip

                if (parentDiv) {
                    parentDiv.classList.remove('hidden'); // Make the parent div visible
                }
            }

            // By default, hide the read aloud button, then show it if the task is appropriate
            elements.readAloudBtn.classList.add('hidden'); // Hide read aloud button
            elements.readAloudBtn.disabled = true; // Disable button

            // Now, selectively disable and clear content, and hide parent divs based on the selected task
            let keysToDisable = [];
            let keysToHideParentDiv = []; // New array to store keys whose parent divs need to be hidden

            // Note: modelSelect is not disabled by task type as it's a fundamental choice.

            switch (selectedTask) {
                case "Correct Vocabulary & Grammar (Minimal Changes)":
                    keysToDisable = ['tone', 'length', 'channel', 'recipient', 'relationship', 'vocab_style', 'role', 'industry'];
                    keysToHideParentDiv = ['tone', 'length', 'channel', 'recipient', 'relationship', 'vocab_style', 'role', 'industry'];
                    break;
                case "Change Tone of Text":
                    keysToDisable = ['language', 'length', 'channel', 'recipient', 'relationship', 'vocab_style', 'role', 'industry'];
                    keysToHideParentDiv = ['language', 'length', 'channel', 'recipient', 'relationship', 'vocab_style', 'role', 'industry'];
                    break;
                case "Summarize Text":
                case "Expand on Text/Idea":
                    keysToDisable = ['tone', 'length', 'channel', 'recipient', 'relationship', 'vocab_style', 'role', 'industry'];
                    keysToHideParentDiv = ['tone', 'length', 'channel', 'recipient', 'relationship', 'vocab_style', 'role', 'industry'];
                    break;
                case "Translate Text":
                    keysToDisable = ['tone', 'length', 'channel', 'recipient', 'relationship', 'vocab_style', 'role', 'industry'];
                    keysToHideParentDiv = ['tone', 'length', 'channel', 'recipient', 'relationship', 'vocab_style', 'role', 'industry'];
                    // Show and enable read aloud button for Translate Text
                    elements.readAloudBtn.classList.remove('hidden');
                    elements.readAloudBtn.disabled = false;
                    break;
                case "English Learning":
                    keysToDisable = ['tone', 'language', 'length', 'channel', 'recipient', 'relationship', 'vocab_style', 'role', 'industry'];
                    keysToHideParentDiv = ['tone', 'language', 'length', 'channel', 'recipient', 'relationship', 'vocab_style', 'role', 'industry'];
                    // Show and enable read aloud button for English Learning
                    elements.readAloudBtn.classList.remove('hidden');
                    elements.readAloudBtn.disabled = false;
                    break;
                case "Dictionary":
                    keysToDisable = ['tone', 'length', 'channel', 'recipient', 'relationship', 'vocab_style', 'role', 'industry'];
                    keysToHideParentDiv = ['tone', 'length', 'channel', 'recipient', 'relationship', 'vocab_style', 'role', 'industry'];
                    // Show and enable read aloud button for Dictionary
                    elements.readAloudBtn.classList.remove('hidden');
                    elements.readAloudBtn.disabled = false;
                    break;
                case "Free Prompt":
                    // For Free Prompt, hide most options
                    keysToDisable = ['tone', 'length', 'channel', 'recipient', 'relationship', 'vocab_style', 'role', 'industry'];
                    keysToHideParentDiv = ['tone', 'length', 'channel', 'recipient', 'relationship', 'vocab_style', 'role', 'industry'];
                    break;
                case "Improve Text":
                case "Rewrite Text":
                    // For Improve Text and Rewrite Text, all options are potentially applicable.
                    keysToDisable = [];
                    keysToHideParentDiv = [];
                    break;
            }

            // Apply disabling and visual clearing for the determined variables
            let disabledCount = 0;
            keysToDisable.forEach(key => {
                const dropdown = optionDropdowns[key];
                if (dropdown) {
                    if (dropdown.value !== "" && !dropdown.disabled) {
                        disabledDropdownValues.set(key, dropdown.value);
                    }
                    dropdown.value = "";
                    dropdown.disabled = true;
                    dropdown.classList.add('opacity-50', 'pointer-events-none');
                    dropdown.title = `This option is not applicable for '${selectedTask}' task and is disabled.`;
                    disabledCount++;
                }
            });

            // Apply hiding for parent divs
            keysToHideParentDiv.forEach(key => {
                const dropdown = optionDropdowns[key];
                if (dropdown) {
                    const parentDiv = dropdown.closest('div');
                    if (parentDiv) {
                        parentDiv.classList.add('hidden'); // Hide the parent div
                    }
                }
            });

            if (showToastMessage && (disabledCount > 0 || keysToHideParentDiv.length > 0)) {
                showToast("Some options have been hidden/disabled because they are not applicable to this task.", 4000);
            }
        }

        /**
         * Generates text/image output based on user inputs and sends it to the selected AI API.
         */
        async function generateOutput() {
            // IMPORTANT: Replace with your actual OpenAI API Key!
            // For production, consider using a backend server to proxy requests
            // to avoid exposing your API key in client-side code.
            const OPENAI_API_KEY = "INSERT_YOUR_OPENAI_API_HERE"; // Replace with your actual OpenAI API Key!
            // IMPORTANT: Replace with your actual Google Gemini API Key!
            const GEMINI_API_KEY = "INSERT_YOUR_GEMINI_API_HERE"; // Replace with your actual Gemini API Key!

            const selectedModel = elements.modelSelect.value;

            if (selectedModel === "openai" && OPENAI_API_KEY === "YOUR_OPENAI_API_KEY") {
                alert("Please set your OpenAI API Key in the JavaScript code or ensure it's provided by the environment. You can get one from https://platform.openai.com/account/api-keys.");
                return;
            }
            if (selectedModel === "gemini" && GEMINI_API_KEY === "YOUR_GEMINI_API_KEY") {
                 alert("Please set your Google Gemini API Key in the JavaScript code or ensure it's provided by the environment. You can get one from https://makers.google.com/key.");
                 return;
            }


            const text = elements.inputText.value.trim();
            const purpose = elements.task.value;
            const channel = elements.channel.value;
            const recipient = elements.recipient.value;
            const relationship = elements.relationship.value;
            const vocabStyle = elements.vocab_style.value;
            const tone = elements.tone.value;
            const role = elements.role.value;
            const industry = elements.industry.value;
            const length = elements.length.value;
            const language = elements.language.value;
            const includeCustomVarsChecked = elements.includeCustomVars.checked; // Get checkbox state

            if (!text && !attachedFile) { // Check if both text and file are empty
                alert("Please enter text or attach an image to process.");
                return;
            }

            const isEmailChannel = (channel === "Email (more formal structure)");
            let promptText = ""; // Use a distinct variable for the text part of the prompt
            // Updated instruction to include LaTeX.
            const markdownInstruction = " Please use Markdown for formatting (bold, italic, bullets, headings, code examples, tables) where appropriate. For mathematical expressions, use LaTeX syntax (e.g., inline: `$E=mc^2$`, display: `$$x = \\frac{-b \\pm \\sqrt{b^2-4ac}}{2a}$$`).";

            // Logic for prompt construction (similar to your existing logic)
            if (purpose === "Free Prompt") {
                // Add custom variables ONLY WHEN purpose is Free Prompt and checkbox is checked
                if (includeCustomVarsChecked && Object.keys(customContextVariables).length > 0) {
                    promptText += "Additional Context/Variables:\n";
                    for (const name in customContextVariables) {
                        promptText += `- ${name}: ${customContextVariables[name]}\n`;
                    }
                    promptText += "\n"; // Add a newline for separation
                }
                promptText += `${text}\n`; // Only use input text for Free Prompt
                promptText += `Please respond in '${language}'.\n`; // Keep language option
                // Add channel-specific guidance for Free Prompt if needed, though most options are hidden
                if (isEmailChannel) {
                    promptText += ` The communication channel is an email. Please include a 'Suggested Subject:' on a new line at the very beginning of your output, followed by the email body.`;
                } else if (channel === "Chat Message (more concise)") {
                    promptText += ` The communication channel is a chat message. Please provide a concise and direct response, suitable for a quick exchange. Do NOT include a subject line or email-like salutations/closings.`;
                } else if (channel === "Report/Note") {
                    promptText += ` The communication channel is a report/note. Please provide a structured and informative response, focusing on clarity and organization. Do NOT include a subject line or email-like salutations/closings.`;
                } else if (channel === "Presentation") {
                     promptText += ` The communication channel is a presentation. Please provide key points and bulleted lists suitable for slides, focusing on conciseness and impact for a visual medium. Do NOT include a subject line or email-like salutations/closings.`;
                } else if (channel === "Meeting Minutes") {
                    promptText += ` The communication channel is meeting minutes. Please structure the output with clear action items and decisions. Do NOT include a subject line or email-like salutations/closings.`;
                }
                promptText += markdownInstruction; // Ensure markdown instruction is consistently added.
            }
            // Other prompt logic remains the same
            else if (["Improve Text", "Rewrite Text"].includes(purpose)) {
                if (includeCustomVarsChecked && Object.keys(customContextVariables).length > 0) {
                    promptText += "Additional Context/Variables:\n";
                    for (const name in customContextVariables) {
                        promptText += `- ${name}: ${customContextVariables[name]}\n`;
                    }
                    promptText += "\n";
                }
                promptText += `Your task is to ${purpose.toLowerCase()} the following text. `;
                if (isEmailChannel) {
                    promptText += `The communication channel is an email, targeting a '${recipient}' with whom the writer has a '${relationship}' relationship. Use a '${tone}' tone and a '${vocabStyle}' vocabulary style. The writer's role is '${role}' in the '${industry}' industry. Include a 'Suggested Subject:' on a new line at the very beginning of your output, followed by the email body.`;
                } else if (channel === "Chat Message (more concise)") {
                    promptText += `The communication channel is a chat message. Make it concise and direct, suitable for a quick exchange with a '${recipient}' (${relationship} relationship). Use a '${tone}' tone and a '${vocabStyle}' vocabulary style. The writer's role is '${role}' in the '${industry}' industry. Do NOT include a subject line or email-like salutations/closings.`;
                } else if (channel === "Report/Note") {
                    promptText += `The communication channel is a report or note. Ensure it is structured and informative, targeting a '${recipient}' (${relationship} relationship). Use a '${tone}' tone and a '${vocabStyle}' vocabulary style. The writer's role is '${role}' in the '${industry}' industry. Focus on clarity and organization. Do NOT include a subject line or email-like salutations/closings.`;
                } else if (channel === "Presentation") {
                     promptText += `The communication channel is a presentation. Provide key points and bulleted lists suitable for slides, targeting a '${recipient}' (${relationship} relationship). Use a '${tone}' tone and a '${vocabStyle}' vocabulary style. The writer's role is '${role}' in the '${industry}' industry. Focus on conciseness and impact for a visual medium. Do NOT include a subject line or email-like salutations/closings.`;
                } else if (channel === "Meeting Minutes") {
                    promptText += `The communication channel is meeting minutes. Structure the output with clear action items and decisions, targeting a '${recipient}' (${relationship} relationship). Use a '${tone}' tone and a '${vocabStyle}' vocabulary style. The writer's role is '${role}' in the '${industry}' industry. Do NOT include a subject line or email-like salutations/closings.`;
                } else { // Default or other channels not specifically handled for Improve/Rewrite
                    promptText += `The communication channel is '${channel}', targeting a '${recipient}' with whom the writer has a '${relationship}' relationship. Use a '${tone}' tone and a '${vocabStyle}' vocabulary style. The writer's role is '${role}' in the '${industry}' industry.`;
                }
                promptText += `Output should be in '${language}'.\n`;
                if (length === "Similar to the original text (+/-10%)") {
                    promptText += "Try to keep the output length similar to the original (within +/-10% of input length).\n";
                } else {
                    promptText += `The length should be '${length}'.\n`;
                }
                promptText += "Avoid straying from the original meaning. Maintain the main idea.";
                promptText += markdownInstruction + `\nOriginal text:\n${text}`;

            } else if (purpose === "Correct Vocabulary & Grammar (Minimal Changes)") {
                promptText += `Correct only grammar and vocabulary if necessary. Do not change the structure or style of the original text.\nAvoid unnecessary edits.` + markdownInstruction + `\nText:\n${text}`;
            } else if (purpose === "Change Tone of Text") {
                promptText += `Change the tone of the following text to '${tone}' while preserving meaning.` + markdownInstruction + `\n${text}`;
            } else if (purpose === "Summarize Text") {
                promptText += `Summarize this text in a concise and clear way.` + markdownInstruction + `\n${text}`;
            } else if (purpose === "Expand on Text/Idea") {
                promptText += `Expand and elaborate on this text or idea.` + markdownInstruction + `\n${text}`;
            } else if (purpose === "Translate Text") {
                promptText += `Translate the following text into '${language}'.\n` + `For better accuracy and context, consider that the original text is from a writer with the role '${role}' in the '${industry}' industry, but focus purely on translation quality. Do NOT add any formatting or extra explanations, just the translated text.\n` + `\n${text}`;
            } else if (purpose === "English Learning") {
                promptText += `You're an English tutor. Analyze the following sentence(s) and explain clearly how to improve them.\n` + `Explain any mistakes in grammar, vocabulary, or phrasing. Suggest clearer, more natural alternatives.` + `Give multiple suggestions for how to say it in a more fluent, conversational way if appropriate.` + markdownInstruction + `\nText:\n${text}`;
            } else if (purpose === "Dictionary") {
                promptText += `Act as an expert lexicographer and linguist. Provide a comprehensive dictionary entry for the following word or phrase: '${text}'.\n` + `Please explain it in '${language}'.\n` + `Your explanation should include:\n` + `1.  **IPA (International Phonetic Alphabet) transcription.**\n` + `2.  **Multiple meanings or definitions, clearly numbered.**\n` + `3.  **Examples of how to use it in sentences, including common collocations or usage with prepositions/articles if applicable.**\n` + `4.  **A list of synonyms.**\n` + `Present the information clearly and concisely, using appropriate Markdown formatting (bold, italic, bullets, numbered lists, headings, code examples) for a dictionary entry.`;
            } else {
                promptText += text; // Fallback if no task matches
            }

            elements.generateBtn.disabled = true;
            elements.generateBtn.classList.add('btn-loading');
            elements.generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Generating...';
            elements.outputDisplay.innerHTML = '<p class="text-gray-500">Generating content... This may take a moment.</p>';

            try {
                let messagesContent = [];
                // If there is prompt text, add it to messagesContent
                if (promptText) {
                    messagesContent.push({ type: "text", text: promptText });
                }

                if (attachedFile) {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const base64Image = e.target.result.split(',')[1]; // Get Base64 string
                        if (selectedModel === "openai") {
                            messagesContent.push({
                                type: "image_url",
                                image_url: { url: `data:${attachedFile.type};base64,${base64Image}` }
                            });
                            await callOpenAI(messagesContent, OPENAI_API_KEY);
                        } else if (selectedModel === "gemini") {
                            // Gemini API uses a slightly different structure for inline data
                            messagesContent.push({
                                inlineData: {
                                    mimeType: attachedFile.type,
                                    data: base64Image
                                }
                            });
                             await callGemini(messagesContent, GEMINI_API_KEY, promptText);
                        }
                    };
                    reader.onerror = () => {
                        throw new Error("Could not read image file.");
                    };
                    reader.readAsDataURL(attachedFile);
                } else {
                    if (selectedModel === "openai") {
                        await callOpenAI(messagesContent, OPENAI_API_KEY);
                    } else if (selectedModel === "gemini") {
                        await callGemini(messagesContent, GEMINI_API_KEY, promptText);
                    }
                }

            } catch (error) {
                console.error("Error generating content:", error);
                elements.outputDisplay.innerHTML = `<p class="text-red-500">An error occurred: ${error.message}</p>`;
            } finally {
                elements.generateBtn.disabled = false;
                elements.generateBtn.classList.remove('btn-loading');
                elements.generateBtn.innerHTML = '<i class="fas fa-paper-plane mr-1"></i>Generate Output';
            }
        }

        /**
         * Calls the OpenAI API with the constructed messages.
         * @param {Array} messagesContent - Array of message parts (text, image_url).
         * @param {string} apiKey - The OpenAI API key.
         */
        async function callOpenAI(messagesContent, apiKey) {
            try {
                const payload = {
                    model: "gpt-4o-mini", // Using multimodal model
                    messages: [{ role: "user", content: messagesContent }],
                    max_tokens: 2000,
                };

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${response.status} - ${errorData.error.message || 'Unknown error'}`);
                }

                const result = await response.json();

                if (result.choices && result.choices.length > 0 && result.choices[0].message && result.choices[0].message.content) {
                    const textOutput = result.choices[0].message.content;
                    elements.outputDisplay.innerHTML = renderMarkdown(textOutput);
                    // Process LaTeX after rendering markdown for the main output display
                    if (window.MathJax) {
                        MathJax.startup.promise.then(() => { // Ensure MathJax is ready before typesetting
                            MathJax.typesetPromise([elements.outputDisplay]).catch((err) => console.error("MathJax typesetting failed on main output:", err));
                        });
                    }
                } else {
                    elements.outputDisplay.innerHTML = '<p class="text-red-500">No output generated. Please try again.</p>';
                }

                showToast('Output generated successfully with OpenAI!');

            } catch (error) {
                console.error("Error calling OpenAI API:", error);
                elements.outputDisplay.innerHTML = `<p class="text-red-500">An error occurred: ${error.message}</p>`;
                showToast('Error generating output with OpenAI!', 4000);
            }
        }

        /**
         * Calls the Google Gemini API with the constructed messages.
         * @param {Array} messagesContent - Array of message parts (text, inlineData for image).
         * @param {string} apiKey - The Gemini API key.
         * @param {string} promptText - The main text prompt for Gemini.
         */
        async function callGemini(messagesContent, apiKey, promptText) {
            try {
                let chatHistory = [{ role: "user", parts: [] }];

                // For Gemini, text parts and inlineData are within the same 'parts' array
                // The order matters for Gemini, text usually comes first for instructions.
                if (promptText) {
                    chatHistory[0].parts.push({ text: promptText });
                }

                // Add image data if available. Ensure inlineData is correctly structured.
                const imageDataPart = messagesContent.find(part => part.inlineData);
                if (imageDataPart) {
                    chatHistory[0].parts.push(imageDataPart);
                }

                const payload = { contents: chatHistory };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${response.status} - ${errorData.error.message || 'Unknown error'}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const textOutput = result.candidates[0].content.parts[0].text;
                    elements.outputDisplay.innerHTML = renderMarkdown(textOutput);
                    // Process LaTeX after rendering markdown for the main output display
                    if (window.MathJax) {
                        MathJax.startup.promise.then(() => { // Ensure MathJax is ready before typesetting
                            MathJax.typesetPromise([elements.outputDisplay]).catch((err) => console.error("MathJax typesetting failed on main output:", err));
                        });
                    }
                } else {
                    elements.outputDisplay.innerHTML = '<p class="text-red-500">No output generated. Please try again.</p>';
                }

                showToast('Output generated successfully with Google Gemini!');

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                elements.outputDisplay.innerHTML = `<p class="text-red-500">An error occurred: ${error.message}</p>`;
                showToast('Error generating output with Google Gemini!', 4000);
            }
        }

        /**
         * Clears both the input and output text areas, and attached file.
         */
        function clearInputAndOutput() {
            elements.inputText.value = '';
            elements.outputDisplay.innerHTML = '';
            // Reset inputText height to ensure buttons move back up
            elements.inputText.style.height = 'auto';
            // Clear attached file and filename display
            attachedFile = null;
            elements.imageAttachmentInput.value = ''; // Clear file input
            elements.attachedFileName.textContent = '';
            // Clear any MathJax processed elements to prevent residual rendering issues
            if (window.MathJax) {
                MathJax.typesetClear([elements.outputDisplay]);
                MathJax.typesetClear([elements.fullViewOutputDisplay]);
            }
        }

        /**
         * Copies the content of the output text area to the clipboard.
         */
        function copyOutputToClipboard() {
            const content = elements.outputDisplay.innerText.trim(); // Use innerText to get visible text
            if (content) {
                // Using Clipboard API if available (modern browsers, secure contexts)
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(content).then(() => {
                        showToast("Output copied to clipboard!"); // Changed to toast
                    }).catch(err => {
                        console.error("Failed to copy:", err);
                        // Fallback for older browsers or if Clipboard API fails
                        fallbackCopyToClipboard(content);
                    });
                } else {
                    fallbackCopyToClipboard(content);
                }
            } else {
                showToast("No content to copy."); // Changed to toast
            }
        }

        function fallbackCopyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed'; // Avoid scrolling to bottom
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try {
                document.execCommand('copy');
                showToast("Output copied to clipboard (fallback method)!"); // Changed to toast
            } catch (err) {
                console.error('Failed to copy using fallback method:', err);
                alert('Could not copy content. Please copy manually.'); // Keep alert for serious fallback issue
            }
            document.body.removeChild(textarea);
        }

        /**
         * Displays the content of the output text area in a new, full-screen modal.
         */
        function showFullViewOutput() {
            const contentToDisplay = elements.outputDisplay.innerHTML; // Get innerHTML to retain markdown rendering
            elements.fullViewOutputDisplay.innerHTML = contentToDisplay;
            // Process LaTeX after rendering markdown for the full view output display
            if (window.MathJax) {
                MathJax.startup.promise.then(() => { // Ensure MathJax is ready before typesetting
                    MathJax.typesetPromise([elements.fullViewOutputDisplay]).catch((err) => console.error("MathJax typesetting failed on full view output:", err));
                });
            }
            elements.fullViewModal.classList.remove('hidden');
        }

        /**
         * Closes the full view modal.
         */
        function closeFullViewModal() {
            elements.fullViewModal.classList.add('hidden');
        }

        /**
         * Saves the current configuration to localStorage.
         */
        function saveConfig() {
            const config = {
                modelSelect: elements.modelSelect.value, // Save model selection
                tone: elements.tone.value,
                language: elements.language.value,
                length: elements.length.value,
                channel: elements.channel.value,
                recipient: elements.recipient.value,
                relationship: elements.relationship.value,
                vocab_style: elements.vocab_style.value,
                role: elements.role.value,
                industry: elements.industry.value,
                task: elements.task.value,
                custom_context_variables: customContextVariables,
                include_custom_vars: elements.includeCustomVars.checked // Save checkbox state
            };
            try {
                localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
                showToast("Current settings saved as default!"); // Changed to toast
            } catch (e) {
                console.error("Error saving settings:", e);
                alert("Failed to save default settings.");
            }
        }

        /**
         * Loads the default configuration from localStorage.
         */
        function loadConfig() {
            try {
                const savedConfig = localStorage.getItem(CONFIG_KEY);
                if (savedConfig) {
                    const config = JSON.parse(savedConfig);

                    elements.modelSelect.value = config.modelSelect || elements.modelSelect.options[0].value; // Load model selection
                    elements.tone.value = config.tone || elements.tone.options[0].value;
                    elements.language.value = config.language || elements.language.options[0].value;
                    elements.length.value = config.length || elements.length.options[0].value;
                    elements.channel.value = config.channel || elements.channel.options[0].value;
                    elements.recipient.value = config.recipient || elements.recipient.options[0].value;
                    elements.relationship.value = config.relationship || elements.relationship.options[0].value;
                    elements.vocab_style.value = config.vocab_style || elements.vocab_style.options[0].value;
                    elements.role.value = config.role || elements.role.options[0].value;
                    elements.industry.value = config.industry || elements.industry.options[0].value;
                    elements.task.value = config.task || elements.task.options[0].value;

                    // Load custom context variables
                    customContextVariables = config.custom_context_variables || {};
                    updateCustomVarsDisplay(); // Update display after loading

                    // Load checkbox state
                    elements.includeCustomVars.checked = (typeof config.include_custom_vars === 'boolean') ? config.include_custom_vars : true; // Default to true

                }
            } catch (e) {
                console.error("Error loading settings:", e);
                // Continue with default UI settings
            }
        }

        // --- Custom Context Variables Functions ---
        function addCustomVariable() {
            const name = elements.varNameInput.value.trim();
            const description = elements.varDescInput.value.trim();

            if (!name) {
                alert("Please enter a Variable Name.");
                return;
            }
            if (!description) {
                alert(`Please enter a Description for '${name}'.`);
                return;
            }

            customContextVariables[name] = description;
            updateCustomVarsDisplay();
            elements.varNameInput.value = '';
            elements.varDescInput.value = '';
            showToast(`Variable '${name}' added/updated successfully.`); // Changed to toast
        }

        function removeSelectedVariable() {
            const selectedItem = elements.customVarsList.querySelector('li.bg-blue-200'); // Find selected item
            if (!selectedItem) {
                alert("Please select a variable to remove.");
                return;
            }

            const variableName = selectedItem.dataset.varName;
            if (variableName && customContextVariables.hasOwnProperty(variableName)) {
                delete customContextVariables[variableName];
                updateCustomVarsDisplay();
                clearCustomVarFields();
                showToast(`Variable '${variableName}' removed.`); // Changed to toast
            }
        }

        function updateCustomVarsDisplay() {
            elements.customVarsList.innerHTML = ''; // Clear current list
            for (const name in customContextVariables) {
                const desc = customContextVariables[name];
                const displayDesc = desc.length > 50 ? desc.substring(0, 50) + '...' : desc;
                const listItem = document.createElement('li');
                listItem.className = 'p-2 border-b border-gray-200 last:border-b-0 hover:bg-gray-100 cursor-pointer rounded';
                listItem.dataset.varName = name; // Store the original name
                listItem.textContent = `${name}: ${displayDesc}`;
                listItem.addEventListener('click', () => {
                    // Remove previous selection highlight
                    const currentlySelected = elements.customVarsList.querySelector('li.bg-blue-200');
                    if (currentlySelected) {
                        currentlySelected.classList.remove('bg-blue-200');
                    }
                    // Add highlight to current selection
                    listItem.classList.add('bg-blue-200');
                    onCustomVarSelect(name, desc);
                });
                elements.customVarsList.appendChild(listItem);
            }
        }

        function onCustomVarSelect(name, desc) {
            elements.varNameInput.value = name;
            elements.varDescInput.value = desc;
        }

        function clearCustomVarFields() {
            elements.varNameInput.value = '';
            elements.varDescInput.value = '';
            const currentlySelected = elements.customVarsList.querySelector('li.bg-blue-200');
            if (currentlySelected) {
                currentlySelected.classList.remove('bg-blue-200');
            }
        }

        function showManageVariablesModal() {
            elements.manageVarsModal.classList.remove('hidden');
            updateCustomVarsDisplay(); // Refresh list when modal opens
            clearCustomVarFields(); // Clear input fields
        }

        function closeManageVarsModal() {
            elements.manageVarsModal.classList.add('hidden');
        }

        /**
         * Handles importing custom variables from a JSON file.
         */
        function importJsonVariables() {
            elements.jsonFileInput.click(); // Trigger the hidden file input click
        }

        /**
         * Processes the selected JSON file.
         * @param {Event} event - The change event from the file input.
         */
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            if (file.type !== 'application/json') {
                alert('Invalid file type. Please select a JSON file.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (typeof importedData !== 'object' || Array.isArray(importedData)) {
                        alert('JSON content must be a key-value object (e.g., {"variable1": "description", "variable2": "description"}).');
                        return;
                    }

                    // Merge imported variables, overwriting existing ones with the same name
                    Object.assign(customContextVariables, importedData);
                    updateCustomVarsDisplay();
                    showToast('Variables imported successfully from JSON!'); // Changed to toast

                } catch (error) {
                    console.error('Error parsing JSON file:', error);
                    alert('Error reading or parsing JSON file. Please ensure it is valid JSON and a simple key-value object.');
                }
            };
            reader.readAsText(file);
            // Clear the file input so the same file can be selected again if needed
            elements.jsonFileInput.value = '';
        }

        /**
         * Exports custom variables to a JSON file.
         */
        function exportJsonVariables() {
            if (Object.keys(customContextVariables).length === 0) {
                showToast("No custom variables to export."); // Changed to toast
                return;
            }

            const dataStr = JSON.stringify(customContextVariables, null, 4); // null, 4 for pretty printing
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'gemini_custom_variables.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url); // Clean up the URL object
            showToast("Custom variables exported to gemini_custom_variables.json!"); // Changed to toast
        }


        /**
         * Applies or removes the 'dark' class from the body and updates the dark mode icon.
         * @param {boolean} isDark - True to apply dark mode, false for light mode.
         */
        function applyDarkMode(isDark) {
            if (isDark) {
                document.body.classList.add('dark');
                elements.darkModeIcon.classList.remove('fa-moon');
                elements.darkModeIcon.classList.add('fa-sun');
                elements.darkModeToggle.title = "Toggle Light Mode";
            } else {
                document.body.classList.remove('dark');
                elements.darkModeIcon.classList.remove('fa-sun');
                elements.darkModeIcon.classList.add('fa-moon');
                elements.darkModeToggle.title = "Toggle Dark Mode";
            }
        }

        /**
         * Loads the dark mode preference from localStorage and applies it.
         */
        function loadDarkModePreference() {
            const isDarkMode = localStorage.getItem(DARK_MODE_KEY) === 'true';
            applyDarkMode(isDarkMode);
        }

        /**
         * Toggles the dark mode state, saves it to localStorage, and applies it.
         */
        function toggleDarkMode() {
            const isCurrentlyDark = document.body.classList.contains('dark');
            const newDarkModeState = !isCurrentlyDark;
            applyDarkMode(newDarkModeState);
            localStorage.setItem(DARK_MODE_KEY, newDarkModeState);
        }

        /**
         * Toggles the collapse state of a panel.
         * @param {HTMLElement} contentElement - The content div to collapse/expand.
         * @param {HTMLElement} iconElement - The icon to rotate.
         * @param {string} panelId - The ID of the panel to save its state.
         */
        function togglePanel(contentElement, iconElement, panelId) {
            const isCollapsed = contentElement.classList.contains('max-h-0');
            if (isCollapsed) {
                contentElement.classList.remove('max-h-0');
                contentElement.classList.add('max-h-full'); // Allow content to take full height
                iconElement.classList.remove('fa-chevron-down');
                iconElement.classList.add('fa-chevron-up');
                localStorage.setItem(PANEL_COLLAPSE_STATE_KEY_PREFIX + panelId, 'expanded');
            } else {
                contentElement.classList.remove('max-h-full');
                contentElement.classList.add('max-h-0');
                iconElement.classList.remove('fa-chevron-up');
                iconElement.classList.add('fa-chevron-down');
                localStorage.setItem(PANEL_COLLAPSE_STATE_KEY_PREFIX + panelId, 'collapsed');
            }
        }

        /**
         * Loads the collapse state of panels from localStorage.
         */
        function loadPanelCollapseStates() {
            const panels = [
                { id: 'optionsPanel', content: elements.optionsPanelContent, icon: elements.optionsPanelIcon },
                { id: 'outputPanel', content: elements.outputPanelContent, icon: elements.outputPanelIcon }
            ];

            panels.forEach(panel => {
                const state = localStorage.getItem(PANEL_COLLAPSE_STATE_KEY_PREFIX + panel.id);
                if (state === 'collapsed') {
                    panel.content.classList.add('max-h-0');
                    panel.content.classList.remove('max-h-full');
                    panel.icon.classList.remove('fa-chevron-up');
                    panel.icon.classList.add('fa-chevron-down');
                } else {
                    // Default or 'expanded'
                    panel.content.classList.remove('max-h-0');
                    panel.content.classList.add('max-h-full');
                    panel.icon.classList.remove('fa-chevron-down');
                    panel.icon.classList.add('fa-chevron-up');
                }
            });
        }

        /**
         * Reads the content aloud using the Web Speech API.
         * Determines source text and language based on the selected task.
         * Toggles speech: if speaking, stops; otherwise, starts.
         */
        function readAloud() {
            if ('speechSynthesis' in window) {
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel(); // Immediately stop if currently speaking
                    showToast("Speech stopped.");
                    return; // Exit the function
                }

                const selectedTask = elements.task.value;
                let textToSpeak = '';
                let langCode = '';

                if (selectedTask === 'Dictionary') {
                    // For Dictionary, read content from inputText and always use English
                    textToSpeak = elements.inputText.value.trim();
                    langCode = 'en-US'; // Always set to English for Dictionary prompt

                    if (!textToSpeak) {
                        showToast("Please enter a word or phrase in the 'Your Input Text' box for Dictionary lookup.");
                        return;
                    }

                } else {
                    // For other prompts, read content from outputDisplay and use language from dropdown
                    textToSpeak = elements.outputDisplay.innerText.trim();
                    const selectedLanguage = elements.language.value;

                    if (!textToSpeak) {
                        showToast("No content to read aloud from the output.");
                        return;
                    }

                    // Map language name from dropdown to ISO 639-1 language code
                    switch (selectedLanguage) {
                        case 'English':
                            langCode = 'en-US';
                            break;
                        case 'Vietnamese':
                            langCode = 'vi-VN';
                            break;
                        case 'Spanish':
                            langCode = 'es-ES';
                            break;
                        case 'French':
                            langCode = 'fr-FR';
                            break;
                        case 'Germany':
                            langCode = 'de-DE';
                            break;
                        case 'Japanese':
                            langCode = 'ja-JP';
                            break;
                        case 'Korean':
                            langCode = 'ko-KR';
                            break;
                        case 'Chinese (Simplified)':
                            langCode = 'zh-CN';
                            break;
                        case 'Chinese (Traditional)':
                            langCode = 'zh-TW';
                            break;
                        // Add other languages if you have them in the dropdown
                        default:
                            langCode = 'en-US'; // Default if no match
                    }
                }

                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                utterance.lang = langCode;

                const voices = window.speechSynthesis.getVoices();
                // Try to find a voice matching the selected language
                const targetVoice = voices.find(voice =>
                    voice.lang === langCode &&
                    (voice.name.includes('Google') || voice.name.includes('Microsoft') || voice.default) // Prioritize Google/Microsoft voices or default
                );

                if (targetVoice) {
                    utterance.voice = targetVoice;
                } else {
                    console.warn(`No specific voice found for language code ${langCode}, using default.`);
                }

                speechSynthesis.speak(utterance);
                showToast("Reading out loud...");
            } else {
                alert("Sorry, your browser does not support the Web Speech API for text-to-speech.");
            }
        }


        // ==== Event Listeners ====
        elements.inputText.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault(); // Prevent new line
                generateOutput();
            }
        });
            // Configure marked.js for better output
            marked.setOptions({
                gfm: true,        // Enable GitHub Flavored Markdown (important for tables)
                breaks: true,     // Convert line breaks to <br> tags (chat-like)
                mangle: false,    // Do not obfuscate email links
                headerIds: false  // Do not automatically create ids for headings
            });
            // --- END OF MARKED.JS CONFIGURATION ---

            loadConfig(); // Load config on startup
            loadDarkModePreference(); // Load dark mode preference on startup
            updateOptionsState(); // Initial update of options state based on loaded task
            loadPanelCollapseStates(); // Load panel collapse states

            // Auto-resize textarea on input
            elements.inputText.addEventListener('input', () => {
                elements.inputText.style.height = 'auto'; // Reset height
                elements.inputText.style.height = elements.inputText.scrollHeight + 'px'; // Set to scroll height
            });


        elements.generateBtn.addEventListener('click', generateOutput);
        elements.clearBtn.addEventListener('click', clearInputAndOutput);
        elements.copyBtn.addEventListener('click', copyOutputToClipboard);
        elements.fullViewBtn.addEventListener('click', showFullViewOutput);
        elements.closeFullViewBtn.addEventListener('click', closeFullViewModal);

        // Task selection change listener (added true to show toast)
        elements.task.addEventListener('change', () => updateOptionsState(true));
        // No need to call updateOptionsState on language change, as it's handled within readAloud
        // elements.language.addEventListener('change', () => updateOptionsState(false));


        // Manage Custom Variables buttons
        elements.manageVarsBtn.addEventListener('click', showManageVariablesModal);
        elements.addUpdateVarBtn.addEventListener('click', addCustomVariable);
        elements.removeVarBtn.addEventListener('click', removeSelectedVariable);
        elements.closeManageVarsBtn.addEventListener('click', closeManageVarsModal);
        elements.clearVarFieldsBtn.addEventListener('click', clearCustomVarFields);

        elements.saveDefaultBtn.addEventListener('click', saveConfig); // Save default config

        // New event listeners for JSON import and export
        elements.importJsonBtn.addEventListener('click', importJsonVariables);
        elements.jsonFileInput.addEventListener('change', handleFileSelect);
        elements.exportJsonBtn.addEventListener('click', exportJsonVariables); // Event listener for export button

        // Dark Mode toggle event listener
        elements.darkModeToggle.addEventListener('click', toggleDarkMode);

        // Event listeners for collapsing panels
        document.querySelectorAll('[data-collapse-target]').forEach(button => {
            button.addEventListener('click', (event) => {
                const targetId = event.currentTarget.dataset.collapseTarget;
                const panelId = event.currentTarget.dataset.panelId;
                const contentElement = document.getElementById(targetId);
                const iconElement = event.currentTarget.querySelector('i');
                if (contentElement && iconElement) {
                    togglePanel(contentElement, iconElement, panelId);
                }
            });
        });

        // Event listeners for Quick Guide and Prompt Examples modals
        elements.quickGuideBtn.addEventListener('click', () => {
            elements.quickGuideModal.classList.remove('hidden');
        });
        elements.closeQuickGuideBtn.addEventListener('click', () => {
            elements.quickGuideModal.classList.add('hidden');
        });

        elements.promptExamplesBtn.addEventListener('click', () => {
            elements.promptExamplesModal.classList.remove('hidden');
        });
        elements.closePromptExamplesBtn.addEventListener('click', () => {
            elements.promptExamplesModal.classList.add('hidden');
        });

        // Add event listener for read aloud button
        elements.readAloudBtn.addEventListener('click', readAloud);

        // Add event listeners for image attachment
        elements.attachImageBtn.addEventListener('click', () => {
            elements.imageAttachmentInput.click();
        });

        elements.imageAttachmentInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                attachedFile = file;
                elements.attachedFileName.textContent = `Selected file: ${file.name}`;
            } else {
                attachedFile = null;
                elements.attachedFileName.textContent = '';
            }
        });
    </script>
</body>
</html>
